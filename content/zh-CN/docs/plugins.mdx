import { Callout } from 'nextra/components';

# 插件

使用插件扩展 Neovate Code 功能，增强开发工作流程。插件是一种通过丰富的钩子来扩展功能的方式。您可以创建自己的插件来添加自己的功能、工具、模型、提供商、系统提示、输出样式、斜杠命令和其他集成。

## 创建插件

插件是一个遵循 `Plugin` 接口的 JavaScript 对象。

```ts
import type { Plugin } from '@neovate/code';
export default const plugin: Plugin = {
  name: 'my-plugin',
  context: () => {
    // 添加更多上下文
    return {
      'Who am I': 'chencheng',
    };
  },
  slashCommand() {
    return [
      {
        type: "prompt",
        name: "foo",
        description: "foo",
        getPromptForCommand: async () => {
          return [
            {
              role: "user",
              content: "print the version of @package.json",
            },
          ];
        },
      },
    ];
  },
}
```

## 创建您自己的代码代理

您可以使用插件系统创建具有自己的模型、功能、工具和其他集成的代码代理。

```ts
import { type Plugin, runNeovate } from '@neovate/code';

const plugin: Plugin = {};
runNeovate({
  productName: 'custom-code-agent',
  version: '0.0.1',
  plugins: [plugin],
});
```

就是这样。现在您可以使用自己的代码代理了。

## 插件钩子

<Callout type="info">
  您可以在插件钩子中使用 `this` 来访问上下文实例。
</Callout>

插件钩子是扩展 Neovate Code 功能的主要方式。有许多可用的钩子。

### agent

返回要注册的子代理定义。插件子代理可被全局或项目级代理覆盖。

- 类型：`SeriesMerge`
- 参数：
- 返回：`PluginAgentDefinition[]`

```ts
const plugin: Plugin = {
  name: 'my-plugin',
  agent() {
    return [
      {
        name: 'my-agent',
        description: 'A custom agent for specific tasks',
        tools: ['read', 'glob', 'grep'],
        systemPrompt: 'You are a specialized agent...',
        isEnabled: (context) => context.config.someFeatureEnabled,
      },
    ];
  },
};
```

`isEnabled` 属性可以是布尔值或函数 `(context: Context) => boolean`。当 `isEnabled` 返回 `false` 时，子代理将对系统隐藏。

### config

返回一个部分配置以与配置合并。此钩子在配置初始化时被调用。

- 类型：`SeriesMerge`
- 参数：
  - opts：
    - config：`Config`
    - argvConfig：`Record<string, any>`
- 返回：`Partial<Config>`

### context

返回要添加到对话中的上下文。

- 类型：`SeriesMerge`
- 参数：
  - opts：
    - userPrompt：`string | null`
    - sessionId：`string`
- 返回：`Record<string, string>`

### conversation

通知插件已进行了对话。

- 类型：`Series`
- 参数：
  - opts：
    - userPrompt：`string | null`
    - result：`LoopResult`
    - startTime：`Date`
    - endTime：`Date`
    - sessionId：`string`
- 返回：`void`

### destroy

此钩子在上下文被销毁时被调用。

- 类型：`Parallel`
- 参数：
- 返回：`void`

### env

返回要添加到对话中的环境上下文。

- 类型：`SeriesMerge`
- 参数：
  - opts：
    - userPrompt：`string | null`
    - sessionId：`string`
- 返回：`Record<string, string>`

### initialized

初始化插件。

- 类型：`Series`
- 参数：
  - opts：
    - cwd：`string`
    - quiet：`boolean`
- 返回：`void`

### modelAlias

修改模型别名。

- 类型：`SeriesLast`
- 参数：
  - modelAlias：`ModelAlias`
- 返回：`ModelAlias`

### outputStyle

返回要注册的输出样式。

- 类型：`SeriesMerge`
- 参数：
- 返回：`OutputStyle[]`

### provider

修改提供商映射。

- 类型：`SeriesLast`
- 参数：
  - providers：`ProvidersMap`
  - opts：
    - models：`ModelMap`
    - defaultModelCreator：`(name: string, provider: Provider) => LanguageModelV2`
    - createOpenAI：`(options: any) => OpenAIProvider`
    - createOpenAICompatible：`(options: any) => OpenAICompatibleProvider`
    - createAnthropic：`(options: any) => AnthropicProvider`
- 返回：`ProvidersMap`

### query

通知插件已进行了查询。

- 类型：`Series`
- 参数：
  - opts：
    - usage：`Usage`
    - startTime：`Date`
    - endTime：`Date`
    - sessionId：`string`
- 返回：`void`

### skill

返回要注册为技能的 `SKILL.md` 文件路径。插件技能具有最低优先级，可被文件系统中的技能覆盖。

- 类型：`SeriesMerge`
- 参数：
- 返回：`string[]`（`SKILL.md` 文件的绝对路径）

```ts
const plugin: Plugin = {
  name: 'my-plugin',
  skill() {
    return [
      path.join(__dirname, 'skills/my-skill/SKILL.md'),
    ];
  },
};
```

### slashCommand

返回要注册的斜杠命令。

- 类型：`SeriesMerge`
- 参数：
- 返回：`SlashCommand[]`

### status

返回要显示的额外状态。

- 类型：`SeriesMerge`
- 参数：
- 返回：`Status`

### stop

当主代理完成响应时触发。用于观察完成事件、收集分析数据和执行完成后操作。

- 类型：`Series`
- 参数：
  - opts：
    - sessionId：`string`
    - result：`LoopResult`
    - usage：`Usage`
    - turnsCount：`number`
    - toolCallsCount：`number`
    - duration：`number`
    - model：`string`
- 返回：`Promise<void> | void`

### subagentStop

当子代理完成其任务时触发。用于观察子代理完成事件和收集分析数据。

- 类型：`Series`
- 参数：
  - opts：
    - parentSessionId：`string`
    - agentId：`string`
    - agentType：`string`
    - result：`AgentExecutionResult`
    - usage：`{ inputTokens: number; outputTokens: number }`
    - totalToolCalls：`number`
    - totalDuration：`number`
    - model：`string`
- 返回：`Promise<void> | void`

### systemPrompt

修改系统提示。

- 类型：`SeriesLast`
- 参数：
  - systemPrompt：`string`
  - opts：
    - isPlan：`boolean`
    - sessionId：`string`
- 返回：`string`

### telemetry

用于收集使用情况分析的遥测钩子。当需要报告遥测事件时调用此钩子。

- 类型：`Series`
- 参数：
  - opts：
    - name：`string` - 遥测事件的名称
    - payload：`Record<string, any>` - 遥测数据载荷
- 返回：`Promise<void> | void`

### tool

返回要使用的额外工具。这对于向对话中添加您自己的工具很有用。

- 类型：`SeriesMerge`
- 参数：
  - opts：
    - isPlan：`boolean`
    - sessionId：`string`
- 返回：`Tool[]`

### toolResult

修改工具结果。

- 类型：`SeriesLast`
- 参数：
  - toolResult：`ToolResult`
  - opts：
    - toolUse：`ToolUse`
    - approved：`boolean`
    - sessionId：`string`
- 返回：`ToolResult`

### toolUse

修改工具使用。

- 类型：`SeriesLast`
- 参数：
  - toolUse：`ToolUse`
  - opts：
    - sessionId：`string`
- 返回：`ToolUse`

### userPrompt

修改用户提示。

- 类型：`SeriesLast`
- 参数：
  - userPrompt：`string`
  - opts：
    - sessionId：`string`
- 返回：`string`
